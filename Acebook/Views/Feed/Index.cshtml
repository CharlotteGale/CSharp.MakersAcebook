@using System.ComponentModel
@model List<Post>

@functions {
  string TimeAgo(DateTime date)
  {
    var ts = DateTime.UtcNow - date;

    if (ts.TotalSeconds < 60)
      return $"{ts.Seconds}s ago";

    if (ts.TotalMinutes < 60)
      return $"{ts.Minutes}m ago";

    if (ts.TotalHours < 24)
      return $"{ts.Hours}h ago";

    if (ts.TotalDays < 7)
      return $"{ts.Days}d ago";

    return date.ToString("dd MMM yyyy");
  }
}

@{
  ViewData["Title"] = "Feed";
}

<div class="container mt-4">

  <h1 class="mb-4">Feed</h1>

  <!-- Write a Post -->
  <div class="new-post-card mb-3">
    <h5 class="card-title">Write a Post</h5>

    <form action="/posts" method="post">
      <div class="mb-3">
        <input type="text"                 name="content"   class="form-field"        placeholder="What's on your mind?" />
      </div>

      <button type="submit" class="post-btn">Submit</button>
    </form>
  </div>

  <!-- Recent Posts -->
  <h3 class="mb-3">Recent Posts</h3>

  @foreach (var post in Model)
  {
    <div class="recent-post-card mb-4 p-3">

      <!-- POST HEADER -->
      <div class="post-header mb-2 d-flex align-items-center">
        <div class="profile-icon">@post.User?.Name?.FirstOrDefault()</div>
        <strong class="ms-2">@post.User?.Name</strong>
      </div>

      @if (Context.Session.GetInt32("user_id") == post.UserId &&
                      Context.Request.Query["editPostId"].ToString() == post.Id.ToString())
      {
        <!-- EDIT MODE -->
        <form action="/posts/edit" method="post" class="edit-post-form mb-2">
          <input type="hidden" name="postId" value="@post.Id" />
          <textarea name="content" class="form-field mb-2">@post.Content</textarea>
          <button type="submit" class="post-btn small-btn me-2">Save</button>
          <a href="/feed" class="cancel-link">Cancel</a>
        </form>
      }
      else
      {
        <!-- NORMAL MODE -->
        <p class="card-text mb-2">@post.Content</p>
        <span class="text-muted small">
          @TimeAgo(post.CreatedAt)

          @if (post.UpdatedAt != null)
          {
            <span class="ms-2">(edited @TimeAgo(post.UpdatedAt.Value))</span>
          }
        </span>
      }

      <!-- POST ACTIONS -->
      @if (Context.Session.GetInt32("user_id") == post.UserId)
      {
        <div class="post-actions mt-1">
          <a href="/feed?editPostId=@post.Id" class="action-link me-2">Edit</a>
          <form action="/posts/delete" method="post" class="d-inline">
            <input type="hidden" name="postId" value="@post.Id" />
            <button type="submit" class="action-link delete">Delete</button>
          </form>
        </div>
      }

      <!-- LIKES -->
      <div class="mt-2">
        <span>@post.Likes.Count like(s)</span>
      </div>

      <form action="/likes/toggle" method="post" class="mt-1">
        <input type="hidden" name="postId" value="@post.Id" />
        @{
          var userId = Context.Session.GetInt32("user_id");
          var userHasLiked = post.Likes.Any(l => l.UserId == userId);
        }
        <button type="submit" class="post-btn">
          @(userHasLiked ? "Unlike" : "Like")
        </button>
      </form>

      <!-- COMMENTS -->
      <div class="mt-2">

        @if (post.Comments != null && post.Comments.Any())
        {
          @foreach (var comment in post.Comments)
          {
            <div class="comment-line d-flex justify-content-between align-items-center mb-2">

              <!-- LEFT SIDE -->
              <div class="d-flex align-items-center flex-wrap">
                <div class="profile-icon">@comment.User?.Name?.FirstOrDefault()</div>
                <strong class="ms-2">@comment.User?.Name</strong>

                @if (!(Context.Session.GetInt32("user_id") == comment.UserId &&
                                                    Context.Request.Query["editCommentId"].ToString() == comment.Id.ToString()))
                {
                  <div class="ms-2">
                    <span class="ms-2">@comment.Content</span>
                    <span class="text-muted small ms-2">
                      @TimeAgo(comment.CreatedAt)
                      @if (comment.UpdatedAt != null)
                      {
                        <span class="ms-2">(edited @TimeAgo(comment.UpdatedAt.Value))</span>
                      }
                    </span>
                  </div>
                }
              </div>

              <!-- RIGHT SIDE -->
              <div class="comment-actions">

                @if (Context.Session.GetInt32("user_id") == comment.UserId &&
                                                    Context.Request.Query["editCommentId"].ToString() == comment.Id.ToString())
                {
                  <form action="/comments/edit" method="post" class="edit-comment-form d-flex align-items-center">
                    <input type="hidden" name="commentId" value="@comment.Id" />
                    <input type="text" name="content" value="@comment.Content" class="form-field me-2 edit-field" />
                    <button type="submit" class="post-btn small-btn me-2">Save</button>
                    <a href="/feed" class="cancel-link">Cancel</a>
                  </form>
                }
                else
                {
                  @if (Context.Session.GetInt32("user_id") == comment.UserId)
                  {
                    <a href="/feed?editCommentId=@comment.Id" class="action-link">Edit</a>

                    <form action="/comments/delete" method="post" class="delete-form">
                      <input type="hidden" name="commentId" value="@comment.Id" />
                      <button type="submit" class="action-link delete">Delete</button>
                    </form>
                  }
                }

              </div>

            </div>
          }
        }
        else
        {
          <div class="text-muted small">No comments yet.</div>
        }

      </div>

      <form asp-controller="Comments"           asp-action="Create"            method="post"              class="comment-form mt-3">

        <input type="hidden" name="postId" value="@post.Id" />

        <div class="comment-input-wrapper">
          <input type="text"             name="content"     class="form-field"              placeholder="Write a comment..." />
        </div>

        <button type="submit" class="post-btn mt-2">Comment</button>
      </form>

    </div>
  }
</div>